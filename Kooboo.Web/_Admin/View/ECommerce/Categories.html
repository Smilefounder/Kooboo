<!-- #layout name=blank-->

<div id="app">
  <div class="page-header">
    <h1 class="title">Product categories</h1>
  </div>
  <kb-breadcrumb :breads="breads"></kb-breadcrumb>

  <div class="navbar navbar-default">
    <div class="container-fluid">
      <a class="btn green navbar-btn" @click="add">Add new category</a>
      <a class="btn red navbar-btn" v-if="selectedRows.length" @click="deletes"
        >Delete</a
      >
    </div>
  </div>

  <kb-table v-if="list" :data="list" show-select :selected.sync="selectedRows">
    <kb-table-column :label="Kooboo.text.common.name" prop="name">
    </kb-table-column>

    <kb-table-column :label="Kooboo.text.common.type">
      <template v-slot="row">
        {{Kooboo.text.commerce.categoryType[row.type]}}
      </template>
    </kb-table-column>

    <kb-table-column :label="Kooboo.text.commerce.rules">
      <template v-slot="row">
        <span v-if="row.type=='Auto'">{{getRules(row.rule)}}</span>
        <span v-else>-</span>
      </template>
    </kb-table-column>

    <kb-table-column :label="Kooboo.text.commerce.productCount">
      <template v-slot="row">
        <span
          class="label green"
          style="cursor: pointer"
          @click.stop="showProducts(row)"
        >
          {{row.productCount}}
        </span>
      </template>
    </kb-table-column>

    <kb-table-column
      :label="Kooboo.text.commerce.status"
      width="50px"
      align="center"
    >
      <template v-slot="row">
        <span
          class="label green"
          :class="row.enable?'green':'gray'"
          style="cursor: pointer"
        >
          <template v-if="row.enable">In stock</template>
          <template v-else>Drop off</template>
        </span>
      </template>
    </kb-table-column>

    <kb-table-column align="right" width="100px">
      <template v-slot="row">
        <a class="btn blue" @click.stop="edit(row.id)"
          >{{ Kooboo.text.common.setting }}</a
        >
      </template>
    </kb-table-column>
  </kb-table>
  <kb-selector-modal
    v-model="showProductsModal"
    :list="products"
    :show-header="false"
    :show-select="false"
  />
  <div
    v-kb-modal="showModal"
    class="modal fade"
    data-backdrop="static"
    data-keyboard="fasle"
  >
    <div class="modal-dialog" style="width: 40%">
      <div class="modal-content">
        <div class="modal-header">
          <button @click="showModal=false" class="close">
            <i class="fa fa-close"></i>
          </button>
          <h4 class="modal-title">Create</h4>
        </div>
        <div class="modal-body" v-if="showModal">
          <kb-form :data="editData">
            <kb-form-item>
              <label class="col-sm-3 control-label">Name</label>
              <div class="col-sm-9">
                <input
                  class="form-control"
                  v-model="editData.name"
                  v-kb-hint="validateModel.name.msg"
                />
              </div>
            </kb-form-item>
            <kb-form-item>
              <label class="col-sm-3 control-label">Type</label>
              <div class="col-sm-9">
                <select v-model="editData.type" class="form-control">
                  <option value="Manual" key="Manual">Manual</option>
                  <option value="Auto" key="Auto">Auto</option>
                </select>
              </div>
            </kb-form-item>
            <kb-form-item>
              <label class="col-sm-3 control-label">Enable</label>
              <div class="col-sm-9">
                <kb-switch v-model="editData.enable"></kb-switch>
              </div>
            </kb-form-item>
            <kb-form-item v-if="editData.type=='Manual'">
              <label class="col-sm-3 control-label">Products</label>
              <div class="col-sm-9" style="max-height: 300px; overflow-y: auto">
                <button
                  type="button"
                  class="btn btn-sm"
                  v-for="item in editData.products"
                  :title="getProductTitle(item)"
                  :key="item"
                  style="margin: 5px 5px 5px 0"
                >
                  <span
                    style="
                      display: inline-flex;
                      max-width: 100px;
                      overflow: hidden;
                      white-space: nowrap;
                    "
                    >{{getProductTitle(item)}}</span
                  >
                  <i
                    class="fa fa-close"
                    @click="editData.products=editData.products.filter(f=>f!=item)"
                  ></i>
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-default"
                  @click="showSelectorModal=true"
                >
                  <i class="fa fa-plus"></i>
                </button>
              </div>
            </kb-form-item>
            <kb-form-item v-if="editData.type=='Auto'">
              <label class="col-sm-3 control-label">Matcher</label>
              <div class="col-sm-9">
                <kb-rule-editor
                  v-if="defines"
                  :defines="defines"
                  :rule="editData.rule"
                />
              </div>
            </kb-form-item>
          </kb-form>
        </div>
        <div class="modal-footer">
          <button class="btn green" @click="save">Save</button>
          <button @click="showModal=false" class="btn gray">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <kb-selector-modal
    v-model="showSelectorModal"
    :list="selectorProducts"
    @ok="productSelected"
    show-select
    :show-header="false"
  />
</div>
<script>
  (function () {
    Kooboo.loadJS([
      "/_Admin/Scripts/kooboo/Guid.js",
      "/_Admin/Scripts/components/kbBreadcrumb.js",
      "/_Admin/Scripts/components/kbTable.js",
      "/_Admin/Scripts/components/kbForm.js",
      "/_Admin/Scripts/components/ECommerce/kb-selector-modal.js",
      "/_Admin/Scripts/components/ECommerce/kb-rule-editor.js",
      "/_Admin/Scripts/lib/bootstrap-switch/bootstrap-switch.min.js",
      "/_Admin/Scripts/components/kbSwitch.js",
    ]);

    Kooboo.loadCSS([
      "/_Admin/Scripts/lib/bootstrap-switch/bootstrap-switch.min.css",
    ]);
  })();
</script>
<script src="/_Admin/View/ECommerce/Categories.js"></script>
